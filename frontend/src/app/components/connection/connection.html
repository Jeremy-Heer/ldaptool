<div class="connection-container">
  <!-- Connection Form -->
  <mat-card class="connection-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>settings_ethernet</mat-icon>
        LDAP Server Connection
      </mat-card-title>
      <mat-card-subtitle>Configure your LDAP server connection settings</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="connectionForm" class="connection-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="host-field">
            <mat-label>Host</mat-label>
            <input matInput formControlName="host" placeholder="ldap.example.com" required>
            <mat-error *ngIf="connectionForm.get('host')?.hasError('required')">
              Host is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="port-field">
            <mat-label>Port</mat-label>
            <input matInput type="number" formControlName="port" required>
            <mat-error *ngIf="connectionForm.get('port')?.hasError('required')">
              Port is required
            </mat-error>
            <mat-error *ngIf="connectionForm.get('port')?.hasError('min') || connectionForm.get('port')?.hasError('max')">
              Port must be between 1 and 65535
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-checkbox formControlName="useSSL" class="ssl-checkbox">
            Use SSL/TLS
          </mat-checkbox>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Bind DN (optional)</mat-label>
            <input matInput formControlName="bindDn" placeholder="cn=admin,dc=example,dc=com">
            <mat-hint>Leave empty for anonymous bind</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Password</mat-label>
            <input matInput type="password" formControlName="password" placeholder="Password">
            <mat-hint>Required only if Bind DN is provided</mat-hint>
          </mat-form-field>
        </div>

        <div class="action-buttons">
          <button mat-raised-button color="primary" 
                  (click)="onTestConnection()" 
                  [disabled]="testing() || connectionForm.invalid"
                  class="test-button">
            <mat-icon *ngIf="testing()">
              <mat-spinner diameter="20"></mat-spinner>
            </mat-icon>
            <mat-icon *ngIf="!testing()">wifi_tethering</mat-icon>
            {{ testing() ? 'Testing...' : 'Test Connection' }}
          </button>

          <button mat-button (click)="onClearConnection()" class="clear-button">
            <mat-icon>clear</mat-icon>
            Clear
          </button>

          <button mat-button color="accent" 
                  (click)="showSaveForm.set(!showSaveForm())"
                  [disabled]="connectionForm.invalid">
            <mat-icon>bookmark_add</mat-icon>
            Save Connection
          </button>
        </div>
      </form>

      <!-- Connection Test Result -->
      @if (testResult()) {
        <mat-card class="result-card" [ngClass]="{
          'success-result': testResult()?.success,
          'error-result': !testResult()?.success
        }">
          <mat-card-content>
            <div class="result-content">
              <mat-icon>{{ testResult()?.success ? 'check_circle' : 'error' }}</mat-icon>
              <span>{{ testResult()?.message }}</span>
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Save Connection Form -->
      @if (showSaveForm()) {
        <mat-card class="save-card">
          <mat-card-header>
            <mat-card-title>Save Connection</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="saveForm" class="save-form">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Connection Name</mat-label>
                <input matInput formControlName="connectionName" placeholder="My LDAP Server" required>
                <mat-error *ngIf="saveForm.get('connectionName')?.hasError('required')">
                  Connection name is required
                </mat-error>
              </mat-form-field>
              
              <div class="save-actions">
                <button mat-raised-button color="primary" 
                        (click)="onSaveConnection()"
                        [disabled]="saveForm.invalid">
                  <mat-icon>save</mat-icon>
                  Save
                </button>
                <button mat-button (click)="showSaveForm.set(false)">
                  Cancel
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      }
    </mat-card-content>
  </mat-card>

  <!-- Saved Connections -->
  @if (savedConnections().length > 0) {
    <mat-card class="saved-connections-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>bookmark</mat-icon>
          Saved Connections
        </mat-card-title>
        <mat-card-subtitle>Load a previously saved connection</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <mat-list class="connections-list">
          @for (connection of savedConnections(); track connection.name) {
            <mat-list-item class="connection-item">
              <div class="connection-info">
                <div class="connection-name">{{ connection.name }}</div>
                <div class="connection-details">
                  {{ connection.host }}:{{ connection.port }}
                  @if (connection.useSSL) {
                    <mat-icon class="ssl-icon">security</mat-icon>
                  }
                </div>
              </div>
              
              <div class="connection-actions">
                <button mat-icon-button 
                        (click)="onLoadSavedConnection(connection)"
                        matTooltip="Load Connection">
                  <mat-icon>play_arrow</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="onDeleteConnection(connection.name!)"
                        matTooltip="Delete Connection"
                        color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </mat-list-item>
            <mat-divider></mat-divider>
          }
        </mat-list>
      </mat-card-content>
    </mat-card>
  }

  <!-- Bookmark URL -->
  <mat-card class="bookmark-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>link</mat-icon>
        Bookmark URL
      </mat-card-title>
      <mat-card-subtitle>Generate a bookmark URL for this connection</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="bookmark-section">
        <mat-form-field appearance="outline" class="bookmark-field">
          <mat-label>Bookmark URL</mat-label>
          <input matInput [value]="getBookmarkUrl()" readonly>
          <button mat-icon-button 
                  matSuffix 
                  [cdkCopyToClipboard]="getBookmarkUrl()"
                  (click)="onGenerateBookmark()"
                  [disabled]="!getBookmarkUrl()"
                  matTooltip="Copy to Clipboard">
            <mat-icon>content_copy</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>
</div>
